<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Car Tracking</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css"> <!-- Link to your CSS file -->
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <section>
        <img id="carImage" src="images/UleminePilt.png" alt="Auto Pilt" />

        <div class="container">
            <!-- Left panel for car information -->
            <div class="left-panel">
                <!-- Car information will appear here -->
                <div id="carInfo">
                    <h3>Auto Parameetrid</h3>
                    <p id="carName">Auto Nimi:</p>
                    <p id="coordinates">Koordinaadid: </p>
                    <p id="batteryInfo"></p>
                </div>

                <div id="batteryChartContainer" style="position: relative; width: 100px; height: 100px;">
                    <canvas id="batteryChart" width="100" height="100"></canvas>
                    <div id="batteryLabel" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2em; font-weight: bold; color: #333;"></div>
                </div>
                <div id="dynamicParameters">
                    <!-- Parameters will be injected here -->
                </div>
                
            </div>

            <!-- Right panel for the map -->
            <div class="right-panel">
                <div id="map"></div> <!-- Map container -->
                <!-- "Back to Car" button under the map -->
                <button class="back-to-car-button" onclick="flyToCarLocation()">Back to Car</button>
            </div>
        </div>
    </section>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Function to get query parameters from the URL
            function getQueryParams() {
                const urlParams = new URLSearchParams(window.location.search);
                return {
                    carId: urlParams.get('carId')
                };
            }

            const markers = {}; // Object to hold markers
            const carId = getQueryParams().carId;
            let carLocation = null; // Store car location for flying back

            // Initialize the map and set the initial view
            var map = L.map('map').setView([59.395720, 24.672221], 13);

            // Add OpenStreetMap tiles to the map
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            if (!carId) {
                alert('No car selected. Please go back to select a car.');
                return;
            }

            // Initial data fetch
            fetchCarData();
            fetchBatteryPercentage();
            fetchVehicleParameters(carId);

            // Function to fetch car data
            function fetchCarData() {
                fetch('http://127.0.0.1:5000/api/cars')
                    .then(response => response.json())
                    .then(data => {
                        const car = data.find(c => c.id == carId); // Find the selected car
                        if (car) {
                            const { name, latitude, longitude } = car;
                            carLocation = [latitude, longitude]; // Store car location

                            // Show car info
                            document.getElementById('carName').textContent = `Auto Nimi: ${name}`;
                            document.getElementById('coordinates').textContent = `Koordinaadid: (${latitude}, ${longitude})`;

                            // Update or add a marker for the car's location
                            if (!markers[carId]) {
                                markers[carId] = L.marker([latitude, longitude]).addTo(map)
                                    .bindPopup(`<b>${name}</b><br>Koordinaadid: (${latitude}, ${longitude})`).openPopup();
                            } else {
                                markers[carId].setLatLng([latitude, longitude]); // Update marker position
                            }
                        } else {
                            alert('Car not found.');
                        }
                    })
                    .catch(error => console.error('Error fetching car data:', error));
            }
            
            // Function to fly to the car's location
            function flyToCarLocation() {
                if (carLocation) {
                    map.flyTo(carLocation, 17, { 
                        animate: true,
                        duration: 2
                    });
                } else {
                    alert("Car location not available.");
                }
            }

            // Function to fetch battery percentage and update the chart
            function fetchBatteryPercentage() {
                fetch(`http://127.0.0.1:5000/api/battery_percentage?vehicle_id=${carId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.parameter_name && data.parameter_value) {
                        const batteryValue = parseFloat(data.parameter_value);

                        // Update chart labels and data
                        batteryChart.data.labels = [`Aku: ${batteryValue} %`];
                        updateBatteryChart(batteryValue);  // Update the chart with the fetched value
                    } else {
                        document.getElementById('batteryInfo').textContent = "Battery information not available.";
                    }
                })
                .catch(error => console.error('Error fetching battery percentage:', error));
            }

            // Initialize the battery doughnut chart
            const ctx = document.getElementById('batteryChart').getContext('2d');
            const batteryChart = new Chart(ctx, {
                type: 'doughnut', // Use doughnut chart
                data: {
                    datasets: [{
                        label: 'Battery Level (%)',
                        data: [0, 100], // Initialize with zero and 100
                        backgroundColor: ['rgba(75, 192, 192, 1)', 'rgba(201, 203, 207, 0.2)'],
                        borderColor: ['rgba(75, 192, 192, 1)', 'rgba(201, 203, 207, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });

            // Function to update the battery chart
            function updateBatteryChart(value) {
                batteryChart.data.datasets[0].data[0] = value; // Update battery level
                batteryChart.data.datasets[0].data[1] = 100 - value; // Update remaining percentage
                batteryChart.update(); // Refresh the chart

                // Update the label inside the chart
                document.getElementById('batteryLabel').textContent = `${value}%`;
            }

            // Function to fetch vehicle parameters and update dynamic info
            async function fetchVehicleParameters(vehicleId) {
                try {
                    const response = await fetch(`http://127.0.0.1:5000/api/vehicle_parameters/${vehicleId}`);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const parameters = await response.json();
                    updateParameters(parameters);
                } catch (error) {
                    console.error('Error fetching vehicle parameters:', error);
                }
            }

            const parameterDisplayNames = {
                'hazzard_lights': 'Ohutuled',
                'high_beam': 'Kaugtuled',
                'marker_lights': 'Gabariidituled',
                'brake_light': 'Pidurdustuli',
                'door_status': 'Uks',
                'current_velocity': 'Hetkene kiirus',
                'driving_mode': 'Sõidurežiim',
            };

            const selectedParameterNames = ['hazzard_lights', 'high_beam', 'marker_lights', 'brake_light', 'door_status', 'current_velocity', 'driving_mode'];

            function updateParameters(parameters) {
                const dynamicParametersDiv = document.getElementById('dynamicParameters');
                dynamicParametersDiv.innerHTML = '<h3> </h3>';

                parameters.forEach(param => {
                    if (selectedParameterNames.includes(param.name)) {
                        let valueText;

                        if (param.unit === "std_msgs::Bool") {
                            valueText = param.value === "1" ? "On" : "Off";
                        } else if (param.name === 'door_status') {
                            valueText = param.value !== null ? (param.value === 0 ? 'Suletud' : 'Avatud') : 'N/A';
                        } else if (param.value !== null) {
                            valueText = param.value;
                        } else {
                            valueText = "N/A";
                        }

                        const displayName = parameterDisplayNames[param.name] || param.name.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());

                        const paramElement = document.createElement('p');
                        paramElement.textContent = `${displayName}: ${valueText}`;
                        dynamicParametersDiv.appendChild(paramElement);
                    }
                });
            }

            setInterval(() => {
                fetchCarData();
                fetchBatteryPercentage();
                fetchVehicleParameters(carId);
            }, 5000);
        });
    </script>

    <!-- Back Button -->
    <button class="back-button" onclick="goBack()">
        ← <span>Back</span>
    </button>

    <script>
        function goBack() {
            window.location.href = 'SelectCar.html';
        }
    </script>

    <style>
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: #ffffff;
            border: none;
            font-size: 1.5em;
            color: #333;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }
        .back-button:hover {
            background-color: #f0f0f0;
        }
        .back-button span {
            margin-left: 5px;
            font-size: 1em;
        }
        .back-to-car-button {
            margin-top: 10px;
            padding: 8px 15px;
            font-size: 1em;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .back-to-car-button:hover {
            background-color: #45a049;
        }
    </style>
</body>
</html>
